# å›è°ƒå‡½æ•°å°è£…å®æˆ˜æŒ‡å—

## ğŸ¯ å¦‚ä½•è¯†åˆ«å›è°ƒå°è£…æœºä¼š

### ğŸ” è¯†åˆ«ä¿¡å·ï¼ˆCode Smellsï¼‰

å½“ä½ åœ¨ä»£ç ä¸­å‘ç°ä»¥ä¸‹æƒ…å†µæ—¶ï¼Œå°±æ˜¯å°è£…å›è°ƒçš„å¥½æ—¶æœºï¼š

#### 1. **é‡å¤çš„æ¨¡æ¿ä»£ç **
```java
// âŒ é‡å¤çš„å¼‚å¸¸å¤„ç†æ¨¡æ¿
public void saveUser(User user) {
    try {
        // ä¸šåŠ¡é€»è¾‘
        userRepository.save(user);
        log.info("ç”¨æˆ·ä¿å­˜æˆåŠŸ: {}", user.getName());
    } catch (Exception e) {
        log.error("ç”¨æˆ·ä¿å­˜å¤±è´¥: {}", e.getMessage());
        throw new BusinessException("ä¿å­˜å¤±è´¥");
    }
}

public void saveOrder(Order order) {
    try {
        // ä¸šåŠ¡é€»è¾‘
        orderRepository.save(order);
        log.info("è®¢å•ä¿å­˜æˆåŠŸ: {}", order.getId());
    } catch (Exception e) {
        log.error("è®¢å•ä¿å­˜å¤±è´¥: {}", e.getMessage());
        throw new BusinessException("ä¿å­˜å¤±è´¥");
    }
}

// âœ… ä½¿ç”¨å›è°ƒå°è£…
public class SafeExecutor {
    public static <T> T execute(String operation, Supplier<T> action) {
        try {
            T result = action.get();
            log.info("{}æˆåŠŸ", operation);
            return result;
        } catch (Exception e) {
            log.error("{}å¤±è´¥: {}", operation, e.getMessage());
            throw new BusinessException(operation + "å¤±è´¥");
        }
    }
}

// ä½¿ç”¨
SafeExecutor.execute("ç”¨æˆ·ä¿å­˜", () -> userRepository.save(user));
SafeExecutor.execute("è®¢å•ä¿å­˜", () -> orderRepository.save(order));
```

#### 2. **æ¡ä»¶åˆ†æ”¯è¿‡å¤š**
```java
// âŒ å¤æ‚çš„æ¡ä»¶å¤„ç†
public void processData(String type, Object data) {
    if ("user".equals(type)) {
        // ç”¨æˆ·å¤„ç†é€»è¾‘
        validateUser((User) data);
        saveUser((User) data);
        sendUserNotification((User) data);
    } else if ("order".equals(type)) {
        // è®¢å•å¤„ç†é€»è¾‘
        validateOrder((Order) data);
        saveOrder((Order) data);
        sendOrderNotification((Order) data);
    } else if ("product".equals(type)) {
        // äº§å“å¤„ç†é€»è¾‘
        validateProduct((Product) data);
        saveProduct((Product) data);
        updateInventory((Product) data);
    }
}

// âœ… ä½¿ç”¨å›è°ƒç­–ç•¥
public class DataProcessor {
    private Map<String, Consumer<Object>> processors = new HashMap<>();
    
    public DataProcessor() {
        processors.put("user", data -> processUser((User) data));
        processors.put("order", data -> processOrder((Order) data));
        processors.put("product", data -> processProduct((Product) data));
    }
    
    public void process(String type, Object data) {
        Consumer<Object> processor = processors.get(type);
        if (processor != null) {
            processor.accept(data);
        } else {
            throw new IllegalArgumentException("æœªçŸ¥ç±»å‹: " + type);
        }
    }
    
    private void processUser(User user) {
        validateUser(user);
        saveUser(user);
        sendUserNotification(user);
    }
}
```

#### 3. **å›ºå®šæµç¨‹ï¼Œå¯å˜æ­¥éª¤**
```java
// âŒ ç¡¬ç¼–ç çš„å¤„ç†æµç¨‹
public void processPayment(PaymentRequest request) {
    // 1. éªŒè¯
    validatePayment(request);
    
    // 2. å¤„ç† - ä¸åŒæ”¯ä»˜æ–¹å¼å¤„ç†é€»è¾‘ä¸åŒ
    if (request.getType() == PaymentType.ALIPAY) {
        // æ”¯ä»˜å®å¤„ç†é€»è¾‘
        callAlipayAPI(request);
    } else if (request.getType() == PaymentType.WECHAT) {
        // å¾®ä¿¡å¤„ç†é€»è¾‘
        callWechatAPI(request);
    }
    
    // 3. è®°å½•
    logPayment(request);
    
    // 4. é€šçŸ¥
    sendNotification(request);
}

// âœ… ä½¿ç”¨å›è°ƒæ¨¡æ¿
public class PaymentProcessor {
    public void processPayment(PaymentRequest request, 
                             Consumer<PaymentRequest> paymentHandler) {
        // å›ºå®šæµç¨‹
        validatePayment(request);
        
        // å¯å˜æ­¥éª¤ - é€šè¿‡å›è°ƒå¤„ç†
        paymentHandler.accept(request);
        
        // å›ºå®šæµç¨‹
        logPayment(request);
        sendNotification(request);
    }
}

// ä½¿ç”¨
processor.processPayment(request, req -> callAlipayAPI(req));
processor.processPayment(request, req -> callWechatAPI(req));
```

## ğŸª å¸¸è§å°è£…åœºæ™¯

### 1. **èµ„æºç®¡ç†åœºæ™¯**

#### æ•°æ®åº“è¿æ¥ç®¡ç†
```java
public class DatabaseTemplate {
    /**
     * æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼Œè‡ªåŠ¨ç®¡ç†è¿æ¥
     * @param operation æ•°æ®åº“æ“ä½œå›è°ƒ
     * @return æ“ä½œç»“æœ
     */
    public <T> T execute(Function<Connection, T> operation) {
        Connection conn = null;
        try {
            conn = dataSource.getConnection();
            conn.setAutoCommit(false);
            
            T result = operation.apply(conn);
            
            conn.commit();
            return result;
        } catch (Exception e) {
            if (conn != null) {
                try {
                    conn.rollback();
                } catch (SQLException ex) {
                    log.error("å›æ»šå¤±è´¥", ex);
                }
            }
            throw new RuntimeException("æ•°æ®åº“æ“ä½œå¤±è´¥", e);
        } finally {
            if (conn != null) {
                try {
                    conn.close();
                } catch (SQLException e) {
                    log.error("å…³é—­è¿æ¥å¤±è´¥", e);
                }
            }
        }
    }
}

// ä½¿ç”¨
Integer userId = dbTemplate.execute(conn -> {
    PreparedStatement ps = conn.prepareStatement(
        "INSERT INTO users (name, email) VALUES (?, ?)", 
        Statement.RETURN_GENERATED_KEYS);
    ps.setString(1, user.getName());
    ps.setString(2, user.getEmail());
    ps.executeUpdate();
    
    ResultSet rs = ps.getGeneratedKeys();
    return rs.next() ? rs.getInt(1) : null;
});
```

#### æ–‡ä»¶æ“ä½œç®¡ç†
```java
public class FileTemplate {
    /**
     * å®‰å…¨çš„æ–‡ä»¶æ“ä½œï¼Œè‡ªåŠ¨å…³é—­èµ„æº
     * @param filePath æ–‡ä»¶è·¯å¾„
     * @param operation æ–‡ä»¶æ“ä½œå›è°ƒ
     */
    public <T> T withFile(String filePath, Function<BufferedReader, T> operation) {
        try (BufferedReader reader = Files.newBufferedReader(Paths.get(filePath))) {
            return operation.apply(reader);
        } catch (IOException e) {
            throw new RuntimeException("æ–‡ä»¶æ“ä½œå¤±è´¥: " + filePath, e);
        }
    }
    
    /**
     * å®‰å…¨çš„æ–‡ä»¶å†™å…¥æ“ä½œ
     * @param filePath æ–‡ä»¶è·¯å¾„
     * @param writer å†™å…¥æ“ä½œå›è°ƒ
     */
    public void writeFile(String filePath, Consumer<BufferedWriter> writer) {
        try (BufferedWriter bw = Files.newBufferedWriter(Paths.get(filePath))) {
            writer.accept(bw);
        } catch (IOException e) {
            throw new RuntimeException("æ–‡ä»¶å†™å…¥å¤±è´¥: " + filePath, e);
        }
    }
}

// ä½¿ç”¨
List<String> lines = fileTemplate.withFile("data.txt", reader -> {
    return reader.lines().collect(Collectors.toList());
});

fileTemplate.writeFile("output.txt", writer -> {
    writer.write("Hello World");
    writer.newLine();
    writer.write("From Callback");
});
```

### 2. **æ€§èƒ½ç›‘æ§åœºæ™¯**

#### æ‰§è¡Œæ—¶é—´ç›‘æ§
```java
public class PerformanceMonitor {
    /**
     * ç›‘æ§æ–¹æ³•æ‰§è¡Œæ—¶é—´
     * @param methodName æ–¹æ³•åç§°
     * @param operation è¦ç›‘æ§çš„æ“ä½œ
     * @return æ“ä½œç»“æœ
     */
    public <T> T monitor(String methodName, Supplier<T> operation) {
        long startTime = System.currentTimeMillis();
        try {
            T result = operation.get();
            long duration = System.currentTimeMillis() - startTime;
            log.info("æ–¹æ³• {} æ‰§è¡Œè€—æ—¶: {}ms", methodName, duration);
            
            // æ€§èƒ½å‘Šè­¦
            if (duration > 1000) {
                log.warn("æ–¹æ³• {} æ‰§è¡Œæ—¶é—´è¿‡é•¿: {}ms", methodName, duration);
            }
            
            return result;
        } catch (Exception e) {
            long duration = System.currentTimeMillis() - startTime;
            log.error("æ–¹æ³• {} æ‰§è¡Œå¤±è´¥ï¼Œè€—æ—¶: {}ms", methodName, duration, e);
            throw e;
        }
    }
    
    /**
     * æ— è¿”å›å€¼æ–¹æ³•ç›‘æ§
     * @param methodName æ–¹æ³•åç§°
     * @param operation è¦ç›‘æ§çš„æ“ä½œ
     */
    public void monitor(String methodName, Runnable operation) {
        monitor(methodName, () -> {
            operation.run();
            return null;
        });
    }
}

// ä½¿ç”¨
List<User> users = monitor.monitor("æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨", () -> {
    return userService.findAll();
});

monitor.monitor("å‘é€é‚®ä»¶", () -> {
    emailService.sendWelcomeEmail(user);
});
```

### 3. **ç¼“å­˜åœºæ™¯**

#### ç¼“å­˜æ¨¡æ¿
```java
public class CacheTemplate {
    private final RedisTemplate<String, Object> redisTemplate;
    
    /**
     * ç¼“å­˜è·å–æ¨¡æ¿ï¼Œå¦‚æœç¼“å­˜ä¸å­˜åœ¨åˆ™æ‰§è¡Œå›è°ƒå¹¶ç¼“å­˜ç»“æœ
     * @param key ç¼“å­˜é”®
     * @param supplier æ•°æ®è·å–å›è°ƒ
     * @param expireSeconds è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
     * @return ç¼“å­˜æˆ–æ–°è·å–çš„æ•°æ®
     */
    @SuppressWarnings("unchecked")
    public <T> T getOrSet(String key, Supplier<T> supplier, long expireSeconds) {
        // å°è¯•ä»ç¼“å­˜è·å–
        T cached = (T) redisTemplate.opsForValue().get(key);
        if (cached != null) {
            log.debug("ç¼“å­˜å‘½ä¸­: {}", key);
            return cached;
        }
        
        // ç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡Œå›è°ƒè·å–æ•°æ®
        log.debug("ç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡Œå›è°ƒ: {}", key);
        T result = supplier.get();
        
        // ç¼“å­˜ç»“æœ
        if (result != null) {
            redisTemplate.opsForValue().set(key, result, expireSeconds, TimeUnit.SECONDS);
            log.debug("æ•°æ®å·²ç¼“å­˜: {}", key);
        }
        
        return result;
    }
    
    /**
     * åˆ†å¸ƒå¼é”æ‰§è¡Œæ¨¡æ¿
     * @param lockKey é”é”®
     * @param operation éœ€è¦åŠ é”æ‰§è¡Œçš„æ“ä½œ
     * @param timeoutSeconds é”è¶…æ—¶æ—¶é—´
     */
    public <T> T withLock(String lockKey, Supplier<T> operation, long timeoutSeconds) {
        String lockValue = UUID.randomUUID().toString();
        boolean locked = false;
        
        try {
            // å°è¯•è·å–é”
            locked = redisTemplate.opsForValue()
                .setIfAbsent(lockKey, lockValue, timeoutSeconds, TimeUnit.SECONDS);
            
            if (!locked) {
                throw new RuntimeException("è·å–é”å¤±è´¥: " + lockKey);
            }
            
            // æ‰§è¡Œä¸šåŠ¡æ“ä½œ
            return operation.get();
            
        } finally {
            // é‡Šæ”¾é”
            if (locked) {
                String script = "if redis.call('get', KEYS[1]) == ARGV[1] then " +
                              "return redis.call('del', KEYS[1]) else return 0 end";
                redisTemplate.execute(new DefaultRedisScript<>(script, Long.class), 
                                    Collections.singletonList(lockKey), lockValue);
            }
        }
    }
}

// ä½¿ç”¨
User user = cacheTemplate.getOrSet(
    "user:" + userId, 
    () -> userService.findById(userId), 
    3600  // 1å°æ—¶è¿‡æœŸ
);

String result = cacheTemplate.withLock(
    "order:process:" + orderId,
    () -> orderService.processOrder(orderId),
    30  // 30ç§’è¶…æ—¶
);
```

### 4. **éªŒè¯åœºæ™¯**

#### å‚æ•°éªŒè¯æ¨¡æ¿
```java
public class ValidationTemplate {
    /**
     * æ‰§è¡ŒéªŒè¯å¹¶å¤„ç†ä¸šåŠ¡é€»è¾‘
     * @param data è¦éªŒè¯çš„æ•°æ®
     * @param validators éªŒè¯å™¨åˆ—è¡¨
     * @param operation éªŒè¯é€šè¿‡åçš„ä¸šåŠ¡æ“ä½œ
     */
    public <T, R> R validateAndExecute(T data, 
                                      List<Consumer<T>> validators,
                                      Function<T, R> operation) {
        // æ‰§è¡Œæ‰€æœ‰éªŒè¯
        for (Consumer<T> validator : validators) {
            validator.accept(data);
        }
        
        // éªŒè¯é€šè¿‡ï¼Œæ‰§è¡Œä¸šåŠ¡é€»è¾‘
        return operation.apply(data);
    }
    
    /**
     * åˆ›å»ºéªŒè¯å™¨
     */
    public static <T> Consumer<T> notNull(Function<T, Object> getter, String fieldName) {
        return data -> {
            if (getter.apply(data) == null) {
                throw new IllegalArgumentException(fieldName + "ä¸èƒ½ä¸ºç©º");
            }
        };
    }
    
    public static Consumer<String> notBlank(String fieldName) {
        return value -> {
            if (value == null || value.trim().isEmpty()) {
                throw new IllegalArgumentException(fieldName + "ä¸èƒ½ä¸ºç©º");
            }
        };
    }
    
    public static <T extends Number> Consumer<T> range(T min, T max, String fieldName) {
        return value -> {
            if (value.doubleValue() < min.doubleValue() || 
                value.doubleValue() > max.doubleValue()) {
                throw new IllegalArgumentException(
                    fieldName + "å¿…é¡»åœ¨" + min + "å’Œ" + max + "ä¹‹é—´");
            }
        };
    }
}

// ä½¿ç”¨
User savedUser = validationTemplate.validateAndExecute(
    user,
    Arrays.asList(
        ValidationTemplate.notNull(User::getName, "ç”¨æˆ·å"),
        ValidationTemplate.notNull(User::getEmail, "é‚®ç®±"),
        data -> ValidationTemplate.notBlank("ç”¨æˆ·å").accept(data.getName()),
        data -> ValidationTemplate.range(18, 100, "å¹´é¾„").accept(data.getAge())
    ),
    validUser -> userService.save(validUser)
);
```

### 5. **é‡è¯•åœºæ™¯**

#### é‡è¯•æ¨¡æ¿
```java
public class RetryTemplate {
    /**
     * å¸¦é‡è¯•çš„æ“ä½œæ‰§è¡Œ
     * @param operation è¦æ‰§è¡Œçš„æ“ä½œ
     * @param maxRetries æœ€å¤§é‡è¯•æ¬¡æ•°
     * @param delayMs é‡è¯•é—´éš”ï¼ˆæ¯«ç§’ï¼‰
     * @param retryCondition é‡è¯•æ¡ä»¶åˆ¤æ–­
     */
    public <T> T executeWithRetry(Supplier<T> operation, 
                                 int maxRetries, 
                                 long delayMs,
                                 Predicate<Exception> retryCondition) {
        Exception lastException = null;
        
        for (int attempt = 0; attempt <= maxRetries; attempt++) {
            try {
                return operation.get();
            } catch (Exception e) {
                lastException = e;
                
                // æ£€æŸ¥æ˜¯å¦åº”è¯¥é‡è¯•
                if (attempt == maxRetries || !retryCondition.test(e)) {
                    break;
                }
                
                log.warn("æ“ä½œå¤±è´¥ï¼Œç¬¬{}æ¬¡é‡è¯•ï¼Œ{}msåé‡è¯•: {}", 
                        attempt + 1, delayMs, e.getMessage());
                
                // ç­‰å¾…åé‡è¯•
                try {
                    Thread.sleep(delayMs);
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    throw new RuntimeException("é‡è¯•è¢«ä¸­æ–­", ie);
                }
            }
        }
        
        throw new RuntimeException("æ“ä½œå¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°: " + maxRetries, lastException);
    }
    
    /**
     * ç®€åŒ–ç‰ˆé‡è¯•ï¼ˆé»˜è®¤é‡è¯•æ¡ä»¶ï¼‰
     */
    public <T> T executeWithRetry(Supplier<T> operation, int maxRetries, long delayMs) {
        return executeWithRetry(operation, maxRetries, delayMs, e -> {
            // é»˜è®¤é‡è¯•æ¡ä»¶ï¼šç½‘ç»œå¼‚å¸¸ã€è¶…æ—¶å¼‚å¸¸
            return e instanceof IOException || 
                   e instanceof TimeoutException ||
                   e.getCause() instanceof SocketTimeoutException;
        });
    }
}

// ä½¿ç”¨
String response = retryTemplate.executeWithRetry(
    () -> httpClient.get("https://api.example.com/data"),
    3,    // æœ€å¤šé‡è¯•3æ¬¡
    1000  // æ¯æ¬¡é—´éš”1ç§’
);

User user = retryTemplate.executeWithRetry(
    () -> userService.findById(userId),
    2,
    500,
    e -> e instanceof DataAccessException  // åªæœ‰æ•°æ®è®¿é—®å¼‚å¸¸æ‰é‡è¯•
);
```

## ğŸ¯ è¯†åˆ«æ–¹æ³•æ€»ç»“

### ğŸ” é—®è‡ªå·±è¿™äº›é—®é¢˜

1. **æ˜¯å¦æœ‰é‡å¤ä»£ç ï¼Ÿ**
   - ç›¸åŒçš„try-catchæ¨¡æ¿
   - ç›¸ä¼¼çš„éªŒè¯é€»è¾‘
   - é‡å¤çš„èµ„æºç®¡ç†ä»£ç 

2. **æ˜¯å¦æœ‰å›ºå®šæµç¨‹ï¼Ÿ**
   - å‰ç½®å¤„ç† â†’ æ ¸å¿ƒé€»è¾‘ â†’ åç½®å¤„ç†
   - è·å–èµ„æº â†’ ä½¿ç”¨èµ„æº â†’ é‡Šæ”¾èµ„æº
   - éªŒè¯ â†’ æ‰§è¡Œ â†’ è®°å½•

3. **æ˜¯å¦éœ€è¦ç­–ç•¥åˆ‡æ¢ï¼Ÿ**
   - ä¸åŒçš„å¤„ç†æ–¹å¼
   - å¯é…ç½®çš„è¡Œä¸º
   - è¿è¡Œæ—¶å†³å®šçš„é€»è¾‘

4. **æ˜¯å¦éœ€è¦æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Ÿ**
   - æ—¥å¿—è®°å½•
   - æ€§èƒ½ç›‘æ§
   - å¼‚å¸¸å¤„ç†
   - äº‹åŠ¡ç®¡ç†

### ğŸª å°è£…çš„å¥½å¤„

1. **å‡å°‘é‡å¤ä»£ç **ï¼šDRYåŸåˆ™
2. **æé«˜å¯è¯»æ€§**ï¼šä¸šåŠ¡é€»è¾‘æ›´æ¸…æ™°
3. **ä¾¿äºæµ‹è¯•**ï¼šé€»è¾‘åˆ†ç¦»ï¼Œæ˜“äºå•å…ƒæµ‹è¯•
4. **å¢å¼ºå¤ç”¨æ€§**ï¼šä¸€æ¬¡å°è£…ï¼Œå¤šå¤„ä½¿ç”¨
5. **é™ä½å‡ºé”™ç‡**ï¼šç»Ÿä¸€å¤„ç†ï¼Œå‡å°‘é—æ¼

### ğŸš€ å®è·µå»ºè®®

1. **ä»å°å¤„å¼€å§‹**ï¼šå…ˆå°è£…ç®€å•çš„é‡å¤é€»è¾‘
2. **é€æ­¥æŠ½è±¡**ï¼šå‘ç°æ¨¡å¼åå†è¿›è¡ŒæŠ½è±¡
3. **ä¿æŒç®€å•**ï¼šä¸è¦è¿‡åº¦è®¾è®¡
4. **æ–‡æ¡£å®Œå–„**ï¼šæ¸…æ¥šè¯´æ˜ä½¿ç”¨æ–¹æ³•å’Œæ³¨æ„äº‹é¡¹
5. **å•å…ƒæµ‹è¯•**ï¼šç¡®ä¿å°è£…çš„æ­£ç¡®æ€§

---

## ğŸ“ å®æˆ˜æ£€æŸ¥æ¸…å•

å½“ä½ å†™ä»£ç æ—¶ï¼Œç»å¸¸é—®è‡ªå·±ï¼š

- [ ] è¿™æ®µä»£ç æˆ‘ä¹‹å‰å†™è¿‡ç±»ä¼¼çš„å—ï¼Ÿ
- [ ] è¿™ä¸ªæ–¹æ³•æ˜¯å¦åŒ…å«äº†å¤šä¸ªèŒè´£ï¼Ÿ
- [ ] è¿™é‡Œçš„å¼‚å¸¸å¤„ç†èƒ½å¦ç»Ÿä¸€ï¼Ÿ
- [ ] è¿™ä¸ªèµ„æºç®¡ç†é€»è¾‘èƒ½å¦å¤ç”¨ï¼Ÿ
- [ ] è¿™ä¸ªéªŒè¯é€»è¾‘å…¶ä»–åœ°æ–¹ä¹Ÿéœ€è¦å—ï¼Ÿ
- [ ] è¿™ä¸ªæ€§èƒ½ç›‘æ§èƒ½å¦è‡ªåŠ¨åŒ–ï¼Ÿ

å¦‚æœç­”æ¡ˆæ˜¯"æ˜¯"ï¼Œé‚£å°±æ˜¯å°è£…å›è°ƒçš„å¥½æ—¶æœºï¼

---

*è®°ä½ï¼šå¥½çš„å°è£…æ¥è‡ªäºå¯¹é‡å¤æ¨¡å¼çš„æ•é”è§‚å¯Ÿå’ŒæŒç»­é‡æ„çš„ä¹ æƒ¯ã€‚*